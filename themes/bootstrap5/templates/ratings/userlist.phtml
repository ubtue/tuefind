<?php
  // Set up breadcrumbs:
  $this->breadcrumbs()->set($this->translate('Your Account'), $this->url('myresearch-home'))
    ->add($this->translate('Ratings'), active: true);

  $this->assetManager()->appendScriptLink('requests.js');
  $tabs = $this->accountCapabilities()->getUserContentTabs();
?>

<?php $this->headTitle($this->translate('Ratings'));?>
<?=$this->component('show-account-menu-button')?>
<div class="<?=$this->layoutClass('mainbody')?>">
  <ul class="nav nav-tabs" role="tablist">
    <?php foreach ($tabs as $tab => $title): ?>
      <li class="nav-item" role="presentation" id="user-content-<?=$this->escapeHtmlAttr($tab)?>" data-tab="<?=$this->escapeHtmlAttr($tab)?>"><a class="<?='ratings' === $tab ? 'active' : ''?> nav-link" href="<?=$this->url($tab . '-' . 'userlist')?>"><?=$this->transEsc($title)?></a></li>
    <?php endforeach; ?>
  </ul>
  <h2><?=$this->transEsc('Your Ratings')?></h2>
  <?php if (count($this->ratings) !== 0): ?>
    <nav class="search-header hidden-print">
      <?php
        $abs = $this->ratings->getAbsoluteItemNumber($this->ratings->getItemCountPerPage());
        $end = min($abs, $this->ratings->getTotalItemCount());
        $transParams = [
          '%%start%%' => $this->localizedNumber($this->ratings->getAbsoluteItemNumber(1)),
          '%%end%%' => $this->localizedNumber($end),
          '%%total%%' => $this->localizedNumber($this->ratings->getTotalItemCount()),
        ];
      ?>
      <div class="search-stats">
        <?=$this->translate('showing_items_of_html', $transParams); ?>
      </div>
      <?=$this->context($this)->renderInContext('myresearch/controls/sort.phtml', ['sortList' => $this->sortList]); ?>
    </nav>
    <form action="<?=$this->url('ratings-deleteratings')?>" name="updateForm" id="select_all_ratings" method="post">
      <?php if ($this->accountCapabilities()->isRatingRemovalAllowed()): ?>
        <input type="hidden" value="<?=$this->escapeHtmlAttr($this->auth()->getManager()->getCsrfHash())?>" name="csrf">
        <label>
          <div class="checkbox">
            <input type="checkbox" name="selectAll" class="checkbox-select-all">
            <?=$this->transEsc('select_all_on_page')?>
          </div>
        </label>
        <?=
          $this->component(
              'confirm-button',
              [
                  'buttonId' => 'cancelSelected',
                  'buttonName' => 'cancelSelected',
                  'buttonLabel' => 'delete_selected',
                  'header' => 'confirm_userrating_delete_selected_text',
                  'confirmId' => 'confirm_cancel_selected_yes',
                  'cancelClass' => 'confirm_cancel_no',
                  'ignoreLightbox' => true,
              ]
          )
        ?>
      <?php endif; ?>
      <table class="usercontent-table table-striped table table-responsive">
        <thead>
          <tr>
            <th></th>
            <th><?=$this->transEsc('Created')?></th>
            <th><?=$this->transEsc('Title')?></th>
            <th><?=$this->transEsc('Rating')?></th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($this->ratings as $rating):?>
            <tr>
              <td class="checkbox-col">
                <?php if ($this->accountCapabilities()->isRatingRemovalAllowed()):?>
                  <div class="checkbox-container result">
                    <div class="checkbox">
                      <label class="record-checkbox">
                        <span class="sr-only"><?=$this->transEsc('Select');?></span>
                        <input class="checkbox-select-item" type="checkbox" name="deleteSelectedrating[]" value="<?=$this->escapeHtmlAttr(($rating['id']))?>" id="checkbox_rating_<?=$rating['id']?>">
                      </label>
                    </div>
                  </div>
                <?php endif; ?>
              </td>
              <td data-label="<?=$this->transEscAttr('Created')?>"><?=$this->dateTime()->convertToDisplayDateAndTime('U', $rating['created']->getTimestamp())?></td>
              <td data-label="<?=$this->transEscAttr('Title')?>">
                <a href="<?=$this->url('record', ['id' => $rating['record_id']])?>"><?=$this->escapeHtml($rating['recordTitle'])?></a>
              </td>
              <td class="user-rating" data-label="<?=$this->transEscAttr('Rating')?>">
                <a href="<?=$this->escapeHtmlAttr($this->recordLinker()->getActionUrl($rating['source'] . '|' . $rating['record_id'], 'Rating'))?>" data-lightbox>
                  <?=$this->component('star-rating', ['readonly' => true, 'ratingData' => ['rating' => $rating['rating'], 'count' => 1]])?>
                </a>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </form>
  <?php else: ?>
    <?=$this->transEsc('No Ratings')?>
  <?php endif; ?>
  <?=$this->paginationControl($this->ratings, 'Sliding', 'Helpers/pagination.phtml', ['params' => $this->params])?>
</div>

<div class="<?=$this->layoutClass('sidebar')?>" id="myresearch-sidebar" role="navigation" aria-label="<?=$this->transEsc('account_menu_label')?>">
  <?=$this->accountMenu()->render('usercontent')?>
</div>
