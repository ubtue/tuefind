<?php
  $this->headScript()->appendFile('facets.js');

  // Save results/options to $this so they are available to sub-templates:
  $this->results = $results = $this->recommend->getResults();
  $this->options = $options = $results->getOptions();
  $collapsedFacets = $this->recommend->getCollapsedFacets();
  $forceUncollapsedFacets = [];
  $suppressCountFacets =  $this->recommend->getSuppressCountFacets();

  // Make sure facets with active selections are not collapsed:
  $filterList = $results->getParams()->getFilterList(true);
  foreach ($filterList as $field => $filters) {
    foreach ($filters as $filter) {
      $index = isset($filter['field']) ? array_search($filter['field'], $collapsedFacets) : false;
      if ($index !== false) {
        unset($collapsedFacets[$index]); // Open if we have a match
        $forceUncollapsedFacets[] = $filter['field'];
      }
    }
  }

  $hierarchicalFacets = $this->recommend->getHierarchicalFacets();
  if ($hierarchicalFacets) {
    // jstree.min.js used to be injected by hierarchical-facet.js, but with deferred
    // processing it's called too late to append anything to the headers.
    $this->headScript()->appendFile('vendor/jsTree/jstree.min.js');
    $this->headScript()->appendFile('jstree-vufind-facet-plugin.js');

  }
?>
<button class="close-offcanvas btn btn-link" data-toggle="offcanvas"><?=$this->transEsc('navigate_back') ?></button>
<?php if ($results->getResultTotal() > 0): ?>
  <h2><?=$this->transEsc(isset($this->overrideSideFacetCaption) ? $this->overrideSideFacetCaption : 'Narrow Search')?></h2>
<?php endif; ?>
<?php $checkboxFilters = $this->recommend->getCheckboxFacetSet(); ?>
<?php $checkboxesShown = false; ?>
<?php if (count($checkboxFilters) > 0):
    foreach ($checkboxFilters as $current) {
      if ($results->getResultTotal() > 0 || $current['alwaysVisible']) {
        $checkboxesShown = true;
        break;
      }
    }
  ?>
  <?php if ($checkboxesShown): ?>
    <div class="checkboxFilter">
      <?=$this->context($this)->renderInContext('Recommend/SideFacets/checkbox-filters.phtml', ['checkboxFilters' => $checkboxFilters, 'results' => $results]); ?>
    </div>
  <?php endif; ?>
<?php endif; ?>

<?php
  /* TueFind: This block needs to stay to keep VuFind 5 like behaviour.
   * We want the active facets shown in the sidebar instead of below the searchbox.
   * Note that hiding of the searchbox filters is done via css.
   */
?>
<?php $extraFilters = isset($this->extraSideFacetFilters) ? $this->extraSideFacetFilters : []; ?>
<?php $collapsedFacets = $this->recommend->getCollapsedFacets() ?>
<?php $filterList = array_merge($results->getParams()->getFilterList(true), $extraFilters); ?>
<?php if (!empty($filterList)): ?>
  <?=$this->context($this)->renderInContext('Recommend/SideFacets/filter-list.phtml', [
    'collapsedFacets' => $collapsedFacets,
    'extraFilters' => $extraFilters,
    'filterList' => $filterList,
  ]); ?>
<?php endif; ?>

<?= isset($this->sideFacetExtraControls) ? $this->sideFacetExtraControls : '' ?>
<?php $sideFacetSet = $this->recommend->getFacetSet(); ?>
<?php $hierarchicalFacets = $this->recommend->getHierarchicalFacets() ?>
<?php $hierarchicalFacetSortOptions = $this->recommend->getHierarchicalFacetSortOptions() ?>
<?php if (!empty($sideFacetSet) && $results->getResultTotal() > 0): ?>
  <?php foreach ($sideFacetSet as $title => $cluster): ?>
    <?php $collapsed = in_array($title, $collapsedFacets); ?>
    <div class="facet-group" id="side-panel-<?=$this->escapeHtmlAttr($title) ?>">
      <button class="title<?php if ($collapsed): ?> collapsed<?php endif ?>" data-toggle="collapse" data-target="#side-collapse-<?=$this->escapeHtmlAttr($title) ?>" >
        <span class="facet-title"><?=$this->transEsc($cluster['label'])?></span>
        <?=$this->icon('collapse', 'facet-title-icon') ?>
      </button>
      <div id="side-collapse-<?=$this->escapeHtmlAttr($title) ?>" role="listbox" class="collapse<?php if (!in_array($title, $collapsedFacets)): ?> in<?php endif ?>"<?php if (in_array($title, $forceUncollapsedFacets)): ?> data-force-in="1"<?php endif ?>>
        <?=
          $this->context($this)->renderInContext(
          'Recommend/SideFacets/facet.phtml',
          [
            'facet' => $title,
            'cluster' => $cluster,
            'collapsedFacets' => $collapsedFacets,
            'suppressCountFacets' => $suppressCountFacets
          ]
        );
      ?>
      </div>
    </div>
  <?php endforeach; ?>
<?php endif; ?>
<?=$this->inlineScript(\Laminas\View\Helper\HeadScript::SCRIPT, "registerSideFacetTruncation();", 'SET');?>
