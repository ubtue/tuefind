<?php
    $this->layout()->breadcrumbs = false;
    $this->backgroundTabs = $this->BackgroundTabs ?? [];
    $schemaOrgType = $this->authority()->getSchemaOrgType($this->driver);

    // TueFind:
    // - record.js is needed for AJAX tab logic
    // - disabled, because we use the non-ajax-version.
    // - see also "recordDocReady" at the bottom of this file.
    //$this->headScript()->appendFile("record.js");
?>

<?php /* User Authority Access */ ?>
<?php if ($this->user != false && $this->accountCapabilities()->getRequestAuthorityRightsSetting() === 'enabled'): ?>
  <div>
    <?php if ($this->user_access['availability'] == 'free'): ?>
      <a class="save-record toolbar-btn btn-type-save rel="nofollow" href="<?=$this->url('authority-request-access', ['authority_id' => $this->driver->getUniqueId()])?>" data-lightbox="">Request access rights (This is me!)</a>
    <?php elseif ($this->user_access['availability'] == 'mine' && $this->user_access['access_state'] == 'requested'): ?>
      You have requested permission on this authority record. Our team has been informed, please wait for the approval.
    <?php elseif ($this->user_access['availability'] == 'mine' && $this->user_access['access_state'] == 'granted'): ?>
      This authority record is linked to your user account.
      <?php if ($this->user != false && $this->accountCapabilities()->getPublicationSetting() === 'enabled'): ?>
        <br><a href="<?=$this->url('myresearch-publish')?>">Would you like to publish something?</a>
      <?php endif; ?>
    <?php endif; ?>
  </div>
<?php endif; ?>

<?php /* Record details */ ?>
<div vocab="http://schema.org/" typeof="<?=$schemaOrgType?>">
  <h3><?=$this->authority()->getName($this->driver)?></h3>
  <div class="row">
    <div class="col-sm-8">
      <table class="table table-striped">
        <tbody>
          <?php $occupations = $this->authority()->getOccupations($this->driver);?>
          <?php if ($occupations != ''): ?>
            <tr>
              <th><?=$this->transEsc('Occupation')?>:</th>
              <td><?=$occupations?></td>
            </tr>
          <?php endif; ?>

          <?php $birth = $this->authority()->getBirth($this->driver); ?>
          <?php if ($birth != ''): ?>
            <tr>
              <th><?=$this->transEsc('Born')?>:</th>
              <td><?=$birth?></td>
            </tr>
          <?php endif; ?>

          <?php $death = $this->authority()->getDeath($this->driver); ?>
          <?php if ($death != ''): ?>
            <tr>
              <th><?=$this->transEsc('Died')?>:</th>
              <td><?=$death?></td>
            </tr>
          <?php endif; ?>

          <?php $relations = $this->authority()->getPersonalRelations($this->driver); ?>
          <?php if ($relations != ''): ?>
            <tr>
              <th><?=$this->transEsc('Personal Relations')?>:</th>
              <td><?=$relations?></td>
            </tr>
          <?php endif; ?>

          <?php $relations = $this->authority()->getCorporateRelations($this->driver); ?>
          <?php if ($relations != ''): ?>
            <tr>
              <th><?=$this->transEsc('Corporate Relations')?>:</th>
              <td><?=$relations?></td>
            </tr>
          <?php endif; ?>

          <?php $externalReferences = $this->authority()->getExternalReferences($this->driver); ?>
          <?php if ($externalReferences != ''): ?>
            <tr>
              <th><?=$this->transEsc('External References')?>:</th>
              <td><?=$externalReferences?></td>
            </tr>
          <?php endif; ?>

          <?php $externalResources = $this->authority()->getExternalResources($this->driver); ?>
          <?php if ($externalResources != ''): ?>
            <tr>
              <th><?=$this->transEsc('External Resources')?>:</th>
              <td><?=$externalResources?></td>
            </tr>
          <?php endif; ?>

          <?php $externalSubsystems = $this->authority()->getExternalSubsystems($this->driver, $this->tuefind()->getTueFindSubtype()); ?>
          <?php if ($externalSubsystems != ''): ?>
            <tr>
              <th><?=$this->transEsc('Subsystems')?>:</th>
              <td><?=$externalSubsystems?></td>
            </tr>
          <?php endif; ?>
        </tbody>
      </table>
    </div>
    <?php if ($this->driver->getType() == 'person' && !$this->driver->isFamily()): ?>
      <div class="col-sm-4">
        <?php
          // Image (partially rendered by JS)
          $imgUrl = '/wikidataproxy/load';
          $wikidataId = $this->driver->getWikidataId();
          if ($wikidataId != null) {
            $imgUrl .= '?id=' . $wikidataId;
          } else {
            $imgUrl .= '?search[]=';
            $names = $this->driver->getNameAliases();
            $encodedNames = [];
            foreach ($names as $name) {
              $encodedNames[] = urlencode($name);
            }
            $imgUrl .= implode('&search[]=', $encodedNames);
            $params = ['birthYear' => $this->driver->getBirthYear(),
                       'deathYear' => $this->driver->getDeathYear()];
            foreach ($params as $key => $value) {
              if ($value)
                $imgUrl .= '&' . urlencode($key) . '=' . urlencode($value);
            }
          }
        ?>
        <!-- onload didn't work, so we use a separate script snippet -->
        <div class="tf-wikidata-image" data-url="<?=htmlspecialchars($imgUrl)?>"></div>
        <?=$this->inlineScript(\Laminas\View\Helper\HeadScript::SCRIPT, 'TueFind.GetImagesFromWikidata();', 'SET')?>
      </div>
    <?php endif; ?>
  </div>
</div>

<?=$this->context($this)->renderInContext('Related/AuthorityTitlesBy', ['driver' => $this->driver])?>
<?=$this->context($this)->renderInContext('Related/AuthorityTitlesAbout', ['driver' => $this->driver])?>
<?=$this->context($this)->renderInContext('Related/AuthorityAuthors', ['driver' => $this->driver])?>
<?=$this->context($this)->renderInContext('Related/AuthorityTopics', ['driver' => $this->driver])?>
<?=$this->context($this)->renderInContext('Related/AuthorityTimeline', ['driver' => $this->driver])?>

<?php
  // Pick a tab to display -- Details if available, otherwise first option (if any):
  $tab = $this->tabs['Details'] ?? current($this->tabs) ?? null;
  if(!empty($this->tabs)): ?>
    <h4>Details</h4>
    <div class="col-md-12 tf-cloud-block">
    <div>
        <ul class="nav nav-tabs" role="tablist">
          <?php $activTab = 0; foreach ($this->tabs as $tab => $obj): ?>
          <?php
            $desc = $obj->getDescription();
            $tabName = preg_replace("/\W/", "-", strtolower($tab));
            $activ = '';
            if($activTab == 0) {
              $activ = ' active ';
            }
          ?>
          <li role="presentation" class="<?=$activ;?>">
            <a href="#<?=$tabName?>" role="tab" data-toggle="tab"><?=$this->transEsc($desc)?></a>
          </li>
        <?php $activTab++; endforeach; ?>
        </ul>
        <div class="tab-content tf-p-0">
          <?php $activTab2 = 0; foreach ($this->tabs as $tab => $obj): ?>
            <?php // add current tab to breadcrumbs if applicable:
              $tabName = preg_replace("/\W/", "-", strtolower($tab));
              $activ = '';
              if($activTab2 == 0) {
                $activ = 'active';
              }
            ?>
            <div role="tabpanel" class="tab-pane <?=$activ;?>" id="<?=$tabName?>">
                <?php echo $this->record($this->driver)->getTab($obj)?>
            </div>
          <?php $activTab2++; endforeach; ?>
        </div>
      </div>
    </div>
<?php endif;?>

<?php /* TueFind: Use similar tab logic as for title data (without AJAX!)*/ /*?>
<div class="record-tabs">
  <ul class="nav nav-tabs">
    <?php foreach ($this->tabs as $tab => $obj): ?>
      <?php // add current tab to breadcrumbs if applicable:
        $desc = $obj->getDescription();
        $tabName = preg_replace("/\W/", "-", strtolower($tab));
        $tabClasses = [ 'record-tab', $tabName ];

        if (!isset($this->activeTab) || !$this->activeTab)
          $this->activeTab = $tab;

        if (0 === strcasecmp($this->activeTab, $tab)) {
          if (!$this->loadInitialTabWithAjax || !$obj->supportsAjax()) {
            $tabClasses[] = 'active';
          }
          $tabClasses[] = 'initiallyActive';
          $this->layout()->breadcrumbs .= '<li class="active">' . $this->transEsc($desc) . '</li>';
          $activeTabObj = $obj;
        }
        if (!$obj->isVisible()) { $tabClasses[] = 'hidden'; }
        if (!$obj->supportsAjax()) { $tabClasses[] = 'noajax'; }
      ?>
      <li class="<?=implode(' ', $tabClasses)?>" data-tab="<?=$tabName?>"<?php if ($obj->supportsAjax() && in_array($tab, $this->backgroundTabs)):?> data-background<?php endif ?>>
        <a href="<?=$this->recordLink()->getTabUrl($this->driver, $tab)?>"><?=$this->transEsc($desc)?></a>
      </li>
    <?php endforeach; ?>
  </ul>

  <div class="tab-content">
    <?php if (!$this->loadInitialTabWithAjax || !isset($activeTabObj) || !$activeTabObj->supportsAjax()): ?>
      <div class="tab-pane active <?=$this->escapeHtmlAttr($this->activeTab) ?>-tab">
        <?=isset($activeTabObj) ? $this->record($this->driver)->getTab($activeTabObj) : '' ?>
      </div>
    <?php endif; ?>
  </div>
</div>
 */?>

<?php
  // TueFind:
  // - recordDocReady is needed for AJAX tab logic
  // - disabled, because we use the non-ajax-version.
  // - see also "record.js" at the top of this file.
  // print $this->inlineScript(\Laminas\View\Helper\HeadScript::SCRIPT, '$(document).ready(recordDocReady);', 'SET');
?>
